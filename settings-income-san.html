<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Ajustes de Ingresos</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --bg-color: #121212;
            --surface-color: rgba(30, 30, 30, 0.5);
            --primary-color: #3d99f5;
            --accent-red: #FF5252;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Inter', 'Noto Sans', sans-serif;
            background-image: 
                radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%),
                radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%),
                radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 0.1) 0px, transparent 50%);
        }
        .card-blur {
            @apply backdrop-blur-3xl bg-[var(--surface-color)] border border-[var(--border-color)];
        }
        .input-field {
            @apply w-full bg-white/5 border border-white/10 rounded-md px-4 py-2 focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent text-base placeholder:text-gray-500;
        }
        .btn { @apply font-semibold rounded-md px-4 py-2 text-sm transition-colors; }
        .btn-primary { @apply bg-[var(--primary-color)] text-white hover:bg-blue-500; }
        .btn-secondary { @apply bg-white/10 text-white/80 hover:bg-white/20; }
        .btn-danger { @apply bg-red-500/10 text-[var(--accent-red)] hover:bg-red-500/20; }
    </style>
</head>
<body class="bg-[var(--bg-color)] text-[var(--text-primary)]">
    <div class="flex flex-col min-h-screen">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-gray-800/50 px-6 sm:px-10 py-4 card-blur">
            <a href="dashboard.html" class="text-xl font-bold">Panel de Control Financiero</a>
            <div class="flex items-center gap-4">
                <a id="back-link" href="dashboard.html" class="flex items-center gap-2 rounded-md bg-white/10 px-4 py-2 text-sm font-medium hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Volver al Panel</span>
                </a>
            </div>
        </header>
        <main class="flex-grow p-6 sm:p-10">
            <div class="max-w-xl mx-auto">
                <div class="text-left mb-8">
                    <h2 class="text-3xl font-bold">Gestionar Fuentes de Ingreso</h2>
                    <p class="text-md text-[var(--text-secondary)]">Añade, edita o elimina las plataformas desde donde registras ingresos.</p>
                </div>
                <div class="rounded-lg card-blur p-6">
                    <h3 id="form-title" class="text-xl font-bold mb-4">Añadir Plataforma</h3>
                    <form id="source-form" class="flex items-center gap-3 mb-6">
                        <input type="hidden" id="edit-id-input">
                        <input id="source-name-input" type="text" placeholder="Nombre de la plataforma..." class="input-field" required>
                        <button id="submit-button" type="submit" class="btn btn-primary flex-shrink-0">Añadir</button>
                        <button id="cancel-button" type="button" class="btn btn-secondary flex-shrink-0 hidden">Cancelar</button>
                    </form>
                    <ul id="sources-list" class="space-y-3"></ul>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

      const supabaseUrl = 'https://xchpwqwcgkzhpaxuiiuz.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaHB3cXdjZ2t6aHBheHVpaXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDU5MzEsImV4cCI6MjA3MDM4MTkzMX0.M9Iqzm_foFmvtOEisxnFZg6WsrxltPiUtub425lymcs';
      const supabase = createClient(supabaseUrl, supabaseKey);

      async function main() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        const userId = session.user.id;
        
        const sourcesList = document.getElementById('sources-list');
        const sourceForm = document.getElementById('source-form');
        const sourceNameInput = document.getElementById('source-name-input');
        const editIdInput = document.getElementById('edit-id-input');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-button');

        let allSources = [];

        function setEditMode(source) {
            editIdInput.value = source.id;
            sourceNameInput.value = source.name;
            formTitle.textContent = `Editando: ${source.name}`;
            submitButton.textContent = 'Guardar Cambios';
            cancelButton.classList.remove('hidden');
        }

        function setAddMode() {
            editIdInput.value = '';
            sourceForm.reset();
            formTitle.textContent = 'Añadir Plataforma';
            submitButton.textContent = 'Añadir';
            cancelButton.classList.add('hidden');
        }

        async function fetchSources() {
          const { data, error } = await supabase.from('income_sources').select('*').eq('user_id', userId).order('name');
          if (error) { console.error("Error al cargar fuentes de ingreso:", error); return; }

          allSources = data;
          sourcesList.innerHTML = '';
          data.forEach(source => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between bg-white/5 p-3 rounded-md';
            li.innerHTML = `
              <span class="font-medium">${source.name}</span>
              <div class="flex items-center gap-2">
                <button data-id="${source.id}" class="btn btn-secondary btn-edit">Editar</button>
                <button data-id="${source.id}" class="btn btn-danger btn-delete">Eliminar</button>
              </div>
            `;
            sourcesList.appendChild(li);
          });
        }

        sourceForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const sourceName = sourceNameInput.value.trim();
          if (!sourceName) return;

          const editId = editIdInput.value;
          let error;

          if (editId) {
             const { error: updateError } = await supabase.from('income_sources').update({ name: sourceName }).eq('id', editId);
             error = updateError;
          } else {
            const { error: insertError } = await supabase.from('income_sources').insert({ name: sourceName, user_id: userId });
            error = insertError;
          }

          if (error) { console.error("Error al guardar la fuente:", error); } 
          else { setAddMode(); await fetchSources(); }
        });

        sourcesList.addEventListener('click', async (e) => {
          const button = e.target.closest('button');
          if (!button) return;

          const sourceId = button.dataset.id;
          
          if (button.classList.contains('btn-delete')) {
            if (confirm('¿Estás seguro de que quieres eliminar esta fuente?')) {
              const { error } = await supabase.from('income_sources').delete().eq('id', sourceId);
              if (error) { console.error("Error al eliminar fuente:", error); } 
              else { await fetchSources(); }
            }
          }

          if (button.classList.contains('btn-edit')) {
            const sourceToEdit = allSources.find(s => s.id == sourceId);
            if (sourceToEdit) setEditMode(sourceToEdit);
          }
        });
        
        cancelButton.addEventListener('click', setAddMode);

        await fetchSources();
      }
      
      main();
    </script>
</body>
</html>
