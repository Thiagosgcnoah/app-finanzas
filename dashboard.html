<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  
  const supabaseUrl = 'https://xchpwqwcgkzhpaxuiiuz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaHB3cXdjZ2t6aHBheHVpaXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDU5MzEsImV4cCI6MjA3MDM4MTkzMX0.M9Iqzm_foFmvtOEisxnFZg6WsrxltPiUtub425lymcs';
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Obtenemos la sesión del usuario actual
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    // Si no hay sesión, lo mandamos a la página de inicio
    window.location.href = 'index.html';
  }
  const userId = session.user.id; // ¡Este es el ID de usuario REAL!

  const chatForm = document.getElementById('chat-form');
  // ... (el resto del código de addMessageToHistory) ...

  chatForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const userInput = chatInput.value.trim();
    if (!userInput) return;

    addMessageToHistory('user', userInput);
    chatInput.value = '';
    addMessageToHistory('ia', 'Procesando...');

    try {
      const { data, error } = await supabase.functions.invoke('process-transaction', {
        body: { user_input: userInput, user_id: userId }, // ¡Usamos el ID real!
      })

      if (error) throw error
      
      const lastMessage = chatHistory.querySelector('.ia-msg:last-child p');
      if(lastMessage) lastMessage.textContent = data.message || "¡Listo! He procesado tu solicitud.";

    } catch (error) {
      const lastMessage = chatHistory.querySelector('.ia-msg:last-child p');
      if(lastMessage) lastMessage.textContent = `Lo siento, hubo un error: ${error.message}`;
    }
  });
</script>
