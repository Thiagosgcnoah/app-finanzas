<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Panel de San</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --bg-color: #121212;
            --surface-color: rgba(30, 30, 30, 0.5);
            --primary-color: #3d99f5;
            --secondary-color: #00A99D;
            --accent-red: #FF5252;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
        }
        body {
            font-family: 'Inter', 'Noto Sans', sans-serif;
            background-image: radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%),
                              radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%),
                              radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 0.1) 0px, transparent 50%);
            /* Asegurar que el body tenga un z-index bajo para no interferir con el modal */
            z-index: 0;
        }
        .card-blur {
            @apply backdrop-blur-3xl bg-[var(--surface-color)] border border-white/10;
        }
        .btn-platform {
            @apply bg-white/5 text-white/80 font-semibold rounded-full px-4 py-2 text-sm hover:bg-white/10 transition-colors;
        }
        .btn-platform.active {
            @apply bg-[var(--primary-color)] text-white ring-2 ring-offset-2 ring-offset-gray-900 ring-[var(--primary-color)];
        }
        .progress-bar-bg { @apply bg-white/10 rounded-full h-2; }
        .progress-bar-fill { @apply bg-gradient-to-r from-teal-400 to-cyan-500 h-full rounded-full transition-all duration-500; }
        /* Estilos del Modal */
        .modal-overlay {
            /* Asegurar que el overlay tenga z-index alto y acepte eventos */
            @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 z-50 pointer-events-auto;
        }
        .modal-content {
            @apply w-full max-w-md rounded-lg card-blur p-6 relative;
        }
        /* Estilo para la lista de necesidades en el panel */
        .needs-list-item {
            @apply text-sm text-[var(--text-secondary)] truncate;
        }
    </style>
</head>
<body class="bg-[var(--bg-color)] text-[var(--text-primary)]">
    <div class="flex flex-col min-h-screen">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-gray-800/50 px-6 sm:px-10 py-4 card-blur">
            <h1 id="dashboard-title" class="text-xl font-bold">Panel de Control de San</h1>
            <div class="flex items-center gap-4">
                <a href="settings.html" class="flex items-center gap-2 rounded-md bg-white/10 px-4 py-2 text-sm font-medium hover:bg-white/20">
                    <span>Ajustes</span>
                </a>
                <a id="logout-button" href="#" class="flex items-center gap-2 rounded-md bg-white/10 px-4 py-2 text-sm font-medium hover:bg-white/20">
                    <span>Salir</span>
                </a>
            </div>
        </header>
        <main class="flex-grow p-6 sm:p-10">
            <div class="mx-auto max-w-7xl">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Panel de Fondos Necesarios con lista de nombres -->
                    <div id="needs-card" class="rounded-lg card-blur p-6 cursor-pointer hover:ring-2 hover:ring-[var(--secondary-color)] transition-all">
                        <p class="text-sm font-medium text-[var(--text-secondary)]">Fondos Necesarios (50%)</p>
                        <p id="fondos-necesarios" class="mt-2 text-3xl font-bold text-[var(--secondary-color)]">$0</p>
                        <!-- Contenedor para la lista de nombres de necesidades -->
                        <div id="needs-names-container" class="mt-4 space-y-1"></div>
                    </div>
                    <div class="rounded-lg card-blur p-6">
                        <p class="text-sm font-medium text-[var(--text-secondary)]">Fondo Ahorro (20%)</p>
                        <p id="fondo-ahorro" class="mt-2 text-3xl font-bold text-[var(--secondary-color)]">$0</p>
                    </div>
                    <div class="rounded-lg card-blur p-6">
                        <p class="text-sm font-medium text-[var(--text-secondary)]">Mi Fondo Deseos (15%)</p>
                        <p id="fondo-deseos" class="mt-2 text-3xl font-bold text-[var(--secondary-color)]">$0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="rounded-lg card-blur p-6">
                        <h2 class="text-lg font-semibold mb-4">Registrar Ingreso</h2>
                        <form id="income-form" class="space-y-4">
                             <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-[var(--text-secondary)]">1. Selecciona tu plataforma:</label>
                                    <a href="settings-income-san.html" class="p-1 rounded-full hover:bg-white/10">
                                        <svg class="w-5 h-5 text-[var(--primary-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    </a>
                                </div>
                                <div id="income-sources-buttons" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <label for="income-amount" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">2. Ingresa el monto:</label>
                                <input id="income-amount" type="text" class="w-full bg-white/5 border-white/10 rounded-md" placeholder="Ej: 1.000.000" required>
                            </div>
                            <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-3 rounded-md hover:bg-blue-500">Añadir Ingreso</button>
                        </form>
                    </div>
                    <div class="rounded-lg card-blur p-6">
                        <h2 class="text-lg font-semibold mb-4">Registrar Gasto</h2>
                        <form id="expense-form" class="space-y-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">1. Descripción del gasto:</label>
                                <input id="expense-description" type="text" class="w-full bg-white/5 border-white/10 rounded-md" placeholder="Ej: Mercado, Camisa..." required>
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">2. Monto del gasto:</label>
                                <input id="expense-amount" type="text" class="w-full bg-white/5 border-white/10 rounded-md" placeholder="Ej: 75.000" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">3. Categoría del gasto:</label>
                                <div id="expense-category-buttons" class="flex flex-wrap gap-2">
                                    <button type="button" data-category="necesidad" class="btn-platform">Necesidad</button>
                                    <button type="button" data-category="deseo" class="btn-platform">Deseo</button>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-[var(--accent-red)] text-white font-bold py-3 rounded-md hover:bg-red-600">Añadir Gasto</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal para desglose de necesidades -->
    <div id="needs-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold mb-4">Desglose de Necesidades</h2>
            <div id="needs-breakdown-container" class="mt-4 space-y-3">
                <!-- Contenido dinámico se insertará aquí -->
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // --- Configuración de Supabase ---
        const supabaseUrl = 'https://xchpwqwcgkzhpaxuiiuz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaHB3cXdjZ2t6aHBheHVpaXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDU5MzEsImV4cCI6MjA3MDM4MTkzMX0.M9Iqzm_foFmvtOEisxnFZg6WsrxltPiUtub425lymcs';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Función principal ---
        async function main() {
            // 1. Verificar sesión del usuario
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            const userId = session.user.id;
            
            // 2. Función para formatear moneda
            const formatCurrency = (value) => {
                // Asegurarse de que el valor sea un número antes de formatear
                const numValue = Number(value) || 0;
                return new Intl.NumberFormat('es-CO', { 
                    style: 'currency', 
                    currency: 'COP', 
                    maximumFractionDigits: 0 
                }).format(numValue);
            };
            
            // 3. Variables globales
            let allBudgets = [];
            
            // 4. Obtener elementos del DOM
            const needsModal = document.getElementById('needs-modal');
            const needsCard = document.getElementById('needs-card');
            const closeModalButton = document.getElementById('close-modal-button');
            const needsNamesContainer = document.getElementById('needs-names-container'); // Nuevo contenedor
            
            // Verificación de existencia de elementos críticos
            if (!needsModal || !needsCard || !closeModalButton || !needsNamesContainer) {
                console.error("Error: No se encontraron elementos críticos en el DOM.");
                return;
            }

            // --- Manejo del Modal ---
            
            // 5. Abrir modal al hacer clic en "Fondos Necesarios"
            needsCard.addEventListener('click', () => {
                console.log("Click en 'Fondos Necesarios' - Abriendo modal");
                needsModal.classList.remove('hidden');
                // Forzar visibilidad si hay problemas con 'hidden'
                needsModal.style.display = 'flex';
            });

            // 6. Cerrar modal con el botón X
            closeModalButton.addEventListener('click', () => {
                console.log("Botón X clickeado - Cerrando modal");
                needsModal.classList.add('hidden');
                // Forzar el cierre si no funciona con 'hidden'
                needsModal.style.display = 'none';
            });

            // 7. Cerrar modal al hacer clic fuera del contenido
            needsModal.addEventListener('click', (e) => {
                if (e.target === needsModal) {
                    console.log("Click fuera del modal - Cerrando modal");
                    needsModal.classList.add('hidden');
                    // Forzar el cierre si no funciona con 'hidden'
                    needsModal.style.display = 'none';
                }
            });

            // --- Funciones de datos ---
            
            // 8. Actualizar todos los datos del dashboard (incluyendo lista de nombres)
            async function updateAllData() {
                console.log("Actualizando datos del dashboard...");
                
                const { data: rpcData, error: rpcError } = await supabase.rpc('get_dashboard_data', { p_user_id: userId });
                
                if (rpcError || !rpcData || rpcData.length === 0) {
                    console.error("Error llamando RPC:", rpcError);
                    return;
                }

                const d = rpcData[0];
                allBudgets = d.budget_details || [];

                // Actualizar balances principales con valores por defecto si son null/undefined
                document.getElementById('fondos-necesarios').textContent = formatCurrency(d.shared_needs_balance ?? 0);
                document.getElementById('fondo-ahorro').textContent = formatCurrency(d.shared_savings_balance ?? 0);
                document.getElementById('fondo-deseos').textContent = formatCurrency(d.personal_wishes_balance ?? 0);

                // --- NUEVO: Actualizar lista de nombres de necesidades en el panel ---
                updateNeedsNamesList(d.budget_details || []);

                // Actualizar desglose de necesidades en el MODAL
                const breakdownContainer = document.getElementById('needs-breakdown-container');
                breakdownContainer.innerHTML = ''; // Limpiar contenido previo

                if (Array.isArray(d.budget_details) && d.budget_details.length > 0) {
                    d.budget_details.forEach(budget => {
                        // --- CORRECCIÓN CLAVE: Validación y conversión a número ---
                        const allocated = Number(budget.allocated) || 0;
                        const spent = Number(budget.spent) || 0;
                        const amount = Number(budget.amount) || 0;

                        const remaining = allocated - spent;
                        // Calcular porcentaje con protección contra división por cero
                        const percentage = amount > 0 ? Math.min(100, (remaining / amount) * 100) : 0;

                        const div = document.createElement('div');
                        div.innerHTML = `
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-[var(--text-secondary)] capitalize">${budget.name}</span>
                                <span class="font-medium">${formatCurrency(remaining)} / ${formatCurrency(amount)}</span>
                            </div>
                            <div class="progress-bar-bg mt-1">
                                <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                        `;
                        breakdownContainer.appendChild(div);
                    });
                } else {
                    breakdownContainer.innerHTML = `<p class="text-sm text-[var(--text-secondary)]">Aún no has creado presupuestos para tus necesidades. Ve a <a href="budgets.html" class="underline">Ajustes</a> para empezar.</p>`;
                }
            }

            // 9. --- NUEVA FUNCIÓN: Actualizar lista de nombres en el panel ---
            function updateNeedsNamesList(budgetDetails) {
                needsNamesContainer.innerHTML = ''; // Limpiar contenido previo

                if (Array.isArray(budgetDetails) && budgetDetails.length > 0) {
                    budgetDetails.forEach(budget => {
                        const div = document.createElement('div');
                        div.className = 'needs-list-item'; // Aplicar estilo
                        div.textContent = budget.name;
                        needsNamesContainer.appendChild(div);
                    });
                } else {
                    needsNamesContainer.innerHTML = `<div class="text-xs text-[var(--text-secondary)]">No hay necesidades creadas.</div>`;
                }
            }

            // 10. Renderizar fuentes de ingreso
            async function renderIncomeSources() {
                const { data, error } = await supabase.from('income_sources').select('*').eq('user_id', userId);
                if (error) { 
                    console.error("Error fetching income sources:", error); 
                    return; 
                }
                
                const buttonsContainer = document.getElementById('income-sources-buttons');
                if (!buttonsContainer) return; // Protección adicional
                
                buttonsContainer.innerHTML = '';
                data.forEach(source => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn-platform';
                    button.textContent = source.name;
                    button.dataset.source = source.name;
                    buttonsContainer.appendChild(button);
                });
            }

            // --- Manejo de formularios ---
            
            const incomeForm = document.getElementById('income-form');
            const expenseForm = document.getElementById('expense-form');
            let selectedIncomeSource = null;
            let selectedExpenseCategory = null;

            // 11. Selección de fuente de ingreso
            document.getElementById('income-sources-buttons')?.addEventListener('click', (e) => {
                if(e.target.classList.contains('btn-platform')) {
                    document.querySelectorAll('#income-sources-buttons .btn-platform').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedIncomeSource = e.target.dataset.source;
                }
            });

            // 12. Selección de categoría de gasto
            document.getElementById('expense-category-buttons')?.addEventListener('click', (e) => {
                if(e.target.classList.contains('btn-platform')) {
                    document.querySelectorAll('#expense-category-buttons .btn-platform').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedExpenseCategory = e.target.dataset.category;
                }
            });

            // 13. Función para limpiar números (eliminar puntos)
            const cleanNumber = (numStr) => parseFloat(String(numStr).replace(/\./g, '')) || 0;

            // 14. Manejo del formulario de ingreso
            incomeForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountInput = document.getElementById('income-amount');
                const amount = amountInput?.value;
                
                if (!selectedIncomeSource || !amount) {
                    alert('Por favor, selecciona una plataforma e ingresa un monto.');
                    return;
                }
                
                const cleanAmount = cleanNumber(amount);
                const { error } = await supabase.from('transactions').insert({
                    user_id: userId, 
                    amount: Math.abs(cleanAmount), 
                    description: selectedIncomeSource, 
                    type: 'ingreso', 
                    category: 'ingreso', 
                    status: 'confirmed'
                });
                
                if (error) { 
                    alert('Error registrando ingreso: ' + error.message); 
                } else {
                    incomeForm.reset();
                    document.querySelectorAll('#income-sources-buttons .btn-platform').forEach(btn => btn.classList.remove('active'));
                    selectedIncomeSource = null;
                    await updateAllData();
                }
            });

            // 15. Manejo del formulario de gasto
            expenseForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountInput = document.getElementById('expense-amount');
                const descriptionInput = document.getElementById('expense-description');
                
                const amount = cleanNumber(amountInput?.value);
                const description = descriptionInput?.value.trim();
                
                if (!selectedExpenseCategory || !amount || !description) {
                    alert('Por favor, completa todos los campos para el gasto.');
                    return;
                }

                if (selectedExpenseCategory === 'necesidad') {
                    const budget = allBudgets.find(b => b.name.toLowerCase() === description.toLowerCase());
                    if (!budget) {
                        alert(`No tienes un presupuesto llamado '${description}'. Por favor, créalo primero en Ajustes.`);
                        return;
                    }
                    const availableInBudget = (Number(budget.allocated) || 0) - (Number(budget.spent) || 0);
                    if (amount > availableInBudget) {
                        alert(`Fondos insuficientes en '${description}'. Tienes ${formatCurrency(availableInBudget)} y quieres gastar ${formatCurrency(amount)}.`);
                        return;
                    }
                } else {
                    const wishesBalanceText = document.getElementById('fondo-deseos')?.textContent || "$0";
                    // Extraer número del texto formateado (ej: "$1.000.000" -> 1000000)
                    const wishesBalance = parseFloat(wishesBalanceText.replace(/[^0-9,-]+/g,"").replace(",", ".")) || 0;
                    if (amount > wishesBalance) {
                        alert(`Fondos insuficientes en 'Mi Fondo Deseos'. Tienes ${formatCurrency(wishesBalance)} y quieres gastar ${formatCurrency(amount)}.`);
                        return;
                    }
                }

                const { error } = await supabase.from('transactions').insert({
                    user_id: userId, 
                    amount: -Math.abs(amount), 
                    description: description, 
                    type: 'gasto', 
                    category: selectedExpenseCategory, 
                    status: 'confirmed'
                });

                if (error) { 
                    alert('Error registrando gasto: ' + error.message); 
                } else {
                    expenseForm.reset();
                    document.querySelectorAll('#expense-category-buttons .btn-platform').forEach(btn => btn.classList.remove('active'));
                    selectedExpenseCategory = null;
                    await updateAllData();
                }
            });
            
            // 16. Suscripción a cambios en tiempo real
            supabase.channel('public-db-changes')
              .on('postgres_changes', { event: '*', schema: 'public' }, () => {
                console.log("Cambio detectado en la base de datos, actualizando datos...");
                updateAllData();
                renderIncomeSources();
              })
              .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                  console.log('Conectado a Realtime.');
                  await updateAllData();
                  await renderIncomeSources();
                }
              });

            // 17. Manejo del botón de cierre de sesión
            document.getElementById('logout-button')?.addEventListener('click', async (e) => {
                e.preventDefault();
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            });
            
            // 18. Asegurar que el modal esté oculto al inicio
            needsModal.classList.add('hidden');
            needsModal.style.display = 'none';
        }
        
        // Ejecutar la función principal
        main().catch(error => {
            console.error("Error en la función principal:", error);
        });
    </script>
</body>
</html>
