<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Panel de Control Financiero</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  
  const supabaseUrl = 'https://xchpwqwcgkzhpaxuiiuz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaHB3cXdjZ2t6aHBheHVpaXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDU5MzEsImV4cCI6MjA3MDM4MTkzMX0.M9Iqzm_foFmvtOEisxnFZg6WsrxltPiUtub425lymcs';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    window.location.href = 'index.html';
  }
  const userId = session.user.id;

  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatHistory = document.getElementById('chat-history');

  function addMessageToHistory(sender, text) {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('flex', 'items-start', 'gap-3');
    if (sender === 'user') {
        messageWrapper.classList.add('justify-end');
        messageWrapper.innerHTML = `
            <div>
                <div class="bg-[var(--primary-color)] rounded-lg rounded-tr-none px-4 py-2">
                    <p class="text-sm">${text}</p>
                </div>
                <p class="text-xs text-[var(--text-secondary)] mt-1 text-right">Tú</p>
            </div>
            <div class="flex-shrink-0 size-8 rounded-full bg-white/10 flex items-center justify-center">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            </div>`;
    } else {
        messageWrapper.classList.add('ia-msg');
        messageWrapper.innerHTML = `
            <div class="flex-shrink-0 size-8 rounded-full bg-white/10 flex items-center justify-center">
                <svg class="h-5 w-5 text-[var(--primary-color)]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v6h2V7zm0 8h-2v2h2v-2z"></path></svg>
            </div>
            <div>
                <div class="bg-white/10 rounded-lg rounded-tl-none px-4 py-2">
                    <p class="text-sm">${text}</p>
                </div>
                <p class="text-xs text-[var(--text-secondary)] mt-1">IA</p>
            </div>`;
    }
    chatHistory.appendChild(messageWrapper);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  chatForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const userInput = chatInput.value.trim();
    if (!userInput) return;

    addMessageToHistory('user', userInput);
    chatInput.value = '';
    addMessageToHistory('ia', 'Procesando...');

    try {
      const { data, error } = await supabase.functions.invoke('process-transaction', {
        body: { user_input: userInput, user_id: userId },
      });

      if (error) throw error;
      
      const lastMessageContainer = chatHistory.querySelector('.ia-msg:last-child');
      if (lastMessageContainer) {
        const pElement = lastMessageContainer.querySelector('p.text-sm');
        if (pElement) pElement.textContent = data.message || "¡Listo! He procesado tu solicitud.";
      }

    } catch (error) {
      const lastMessageContainer = chatHistory.querySelector('.ia-msg:last-child');
      if (lastMessageContainer) {
        const pElement = lastMessageContainer.querySelector('p.text-sm');
        if (pElement) pElement.textContent = `Lo siento, hubo un error. Intenta de nuevo.`;
      }
      console.error('Error invoking function:', error);
    }
  });
</script>
<style type="text/tailwindcss">
    :root {
        --bg-color: #121212;
        --surface-color: rgba(30, 30, 30, 0.5);
        --primary-color: #3d99f5;
        --secondary-color: #00A99D;
        --accent-red: #FF5252;
        --text-primary: #FFFFFF;
        --text-secondary: #B0B0B0;
    }
    body {
        font-family: 'Inter', 'Noto Sans', sans-serif;
        background-image: 
            radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%),
            radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%),
            radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 0.1) 0px, transparent 50%);
    }
    .card-blur {
        @apply backdrop-blur-3xl bg-[var(--surface-color)] border border-white/10;
    }
</style>
</head>
<body class="bg-[var(--bg-color)] text-[var(--text-primary)]">
    </body></html>
